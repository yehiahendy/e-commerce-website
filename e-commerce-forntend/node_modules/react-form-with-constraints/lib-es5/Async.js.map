{"version":3,"file":"Async.js","sourceRoot":"","sources":["../src/Async.tsx"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA,6BAA+B;AAC/B,sCAAwC;AAExC,mCAAkC;AAClC,mDAA8E;AAE9E,6DAA6F;AAE7F,iFAAgF;AAEhF,IAAY,MAKX;AALD,WAAY,MAAM;IAChB,mCAAI,CAAA;IACJ,yCAAO,CAAA;IACP,2CAAQ,CAAA;IACR,2CAAQ,CAAA;AACV,CAAC,EALW,MAAM,GAAN,cAAM,KAAN,cAAM,QAKjB;AAyBD;IAAsC,kCAAiD;IAAvF;;IAAyF,CAAC;IAAD,qBAAC;AAAD,CAAC,AAA1F,CAAsC,KAAK,CAAC,aAAa,GAAiC;AAC1F;IACU,yBAIS;IALnB;QAAA,qEA0FC;QApEC,WAAK,GAAkB;YACrB,MAAM,EAAE,MAAM,CAAC,IAAI;SACpB,CAAC;QAUF,cAAQ,GAAG,UAAC,KAAmB;YACvB,IAAA,KAA2B,KAAI,CAAC,OAAO,EAArC,IAAI,UAAA,EAAE,cAAc,oBAAiB,CAAC;YAE9C,IAAI,WAAW,CAAC;YAEhB,IAAM,KAAK,GAAG,IAAI,CAAC,WAAW,CAAC,QAAQ,CAAC,KAAK,CAAC,IAAI,CAAE,CAAC;YAErD,IACE,CAAC,cAAc,CAAC,KAAK,CAAC,IAAI,KAAK,OAAO,IAAI,KAAK,CAAC,YAAY,CAAC,cAAc,CAAC,GAAG,CAAC,CAAC;gBACjF,CAAC,cAAc,CAAC,KAAK,CAAC,IAAI,KAAK,aAAa,IAAI,KAAK,CAAC,SAAS,CAAC,cAAc,CAAC,GAAG,CAAC,CAAC;gBACpF,CAAC,cAAc,CAAC,KAAK,CAAC,IAAI,KAAK,eAAe,IAAI,KAAK,CAAC,WAAW,CAAC,cAAc,CAAC,GAAG,CAAC,CAAC;gBACxF,CAAC,cAAc,CAAC,KAAK,CAAC,IAAI,KAAK,YAAY,IAAI,KAAK,CAAC,QAAQ,CAAC,cAAc,CAAC,GAAG,CAAC,CAAC,EAClF;gBAEA,KAAI,CAAC,QAAQ,CAAC,EAAE,MAAM,EAAE,MAAM,CAAC,IAAI,EAAE,CAAC,CAAC;aACxC;iBAAM;gBACL,WAAW,GAAG,KAAI,CAAC,SAAS,CAAC,KAAK,CAAC,CAAC;aACrC;YAED,OAAO,WAAW,CAAC;QACrB,CAAC,CAAC;;IAoCJ,CAAC;IA1EC,+BAAe,GAAf;QACE,OAAO;YACL,KAAK,EAAE,IAAI;SACZ,CAAC;IACJ,CAAC;IAMD,iCAAiB,GAAjB;QACE,IAAI,CAAC,OAAO,CAAC,cAAc,CAAC,6BAA6B,CAAC,IAAI,CAAC,QAAQ,CAAC,CAAC;IAC3E,CAAC;IAED,oCAAoB,GAApB;QACE,IAAI,CAAC,OAAO,CAAC,cAAc,CAAC,gCAAgC,CAAC,IAAI,CAAC,QAAQ,CAAC,CAAC;IAC9E,CAAC;IAwBK,yBAAS,GAAf,UAAgB,KAAmB;;;;;;wBACjC,IAAI,CAAC,QAAQ,CAAC,EAAE,MAAM,EAAE,MAAM,CAAC,OAAO,EAAE,CAAC,CAAC;;;;wBAE1B,WAAM,IAAI,CAAC,KAAK,CAAC,OAAO,CAAC,KAAK,CAAC,KAAK,CAAC,EAAA;;wBAA7C,KAAK,GAAG,SAAqC;wBACnD,IAAI,CAAC,QAAQ,CAAC,EAAE,MAAM,EAAE,MAAM,CAAC,QAAQ,EAAE,KAAK,OAAA,EAAE,CAAC,CAAC;;;;wBAElD,IAAI,CAAC,QAAQ,CAAC,EAAE,MAAM,EAAE,MAAM,CAAC,QAAQ,EAAE,KAAK,EAAE,GAAC,EAAE,CAAC,CAAC;;4BAGvD,WAAO,IAAI,CAAC,sBAAsB,CAAC,KAAK,CAAC,EAAC;;;;KAC3C;IAED,sBAAM,GAAN;QACQ,IAAA,KAAmB,IAAI,EAArB,KAAK,WAAA,EAAE,KAAK,WAAS,CAAC;QAC9B,IAAI,OAAO,GAAG,IAAI,CAAC;QAEnB,QAAQ,KAAK,CAAC,MAAM,EAAE;YACpB,KAAK,MAAM,CAAC,IAAI;gBACd,MAAM;YACR,KAAK,MAAM,CAAC,OAAO;gBACjB,IAAI,KAAK,CAAC,OAAO;oBAAE,OAAO,GAAG,KAAK,CAAC,OAAO,CAAC;gBAC3C,MAAM;YACR,KAAK,MAAM,CAAC,QAAQ;gBAClB,IAAI,KAAK,CAAC,IAAI;oBAAE,OAAO,GAAG,KAAK,CAAC,IAAI,CAAC,KAAK,CAAC,KAAK,CAAC,CAAC;gBAClD,MAAM;YACR,KAAK,MAAM,CAAC,QAAQ;gBAClB,IAAI,KAAK,CAAC,KAAK;oBAAE,OAAO,GAAG,KAAK,CAAC,KAAK,CAAC,KAAK,CAAC,KAAK,CAAC,CAAC;gBACpD,MAAM;YACR;gBACE,eAAM,CAAC,KAAK,EAAE,sBAAoB,KAAK,CAAC,MAAM,MAAG,CAAC,CAAC;SACtD;QAED,OAAO,OAAO,CAAC;IACjB,CAAC;IAlFM,kBAAY,GAAsC;QACvD,IAAI,EAAE,SAAS,CAAC,UAAU,CAAC,yCAAmB,CAAC,CAAC,UAAU;QAC1D,cAAc,EAAE,SAAS,CAAC,UAAU,CAAC,+BAAc,CAAC,CAAC,UAAU;KAChE,CAAC;IAGK,uBAAiB,GAA2C;QACjE,KAAK,EAAE,SAAS,CAAC,UAAU,CAAC,KAAK,CAAC,CAAC,UAAU;KAC9C,CAAC;IA2EJ,YAAC;CAAA,AA1FD,CACU,6DAA6B,CAInC,cAAc,CAAC,GAqFlB;AA1FY,sBAAK","sourcesContent":["import * as React from 'react';\nimport * as PropTypes from 'prop-types';\n\nimport { assert } from './assert';\nimport { FieldFeedbacks, FieldFeedbacksChildContext } from './FieldFeedbacks';\nimport { FieldFeedbackValidation } from './FieldFeedbackValidation';\nimport { FormWithConstraints, FormWithConstraintsChildContext } from './FormWithConstraints';\nimport { InputElement } from './InputElement';\nimport { withValidateFieldEventEmitter } from './withValidateFieldEventEmitter';\n\nexport enum Status {\n  None,\n  Pending,\n  Rejected,\n  Resolved\n}\n\nexport interface AsyncProps<T> {\n  promise: (value: string) => Promise<T>;\n  pending?: React.ReactNode;\n  then?: (value: T) => React.ReactNode;\n  catch?: (reason: any) => React.ReactNode;\n}\n\ninterface AsyncState<T> {\n  status: Status;\n  value?: T;\n}\n\nexport interface AsyncChildContext {\n  async: Async<any>;\n}\n\nexport type AsyncContext = FormWithConstraintsChildContext & FieldFeedbacksChildContext;\n\n// [Asynchronous form errors and messages in AngularJS](https://jaysoo.ca/2014/10/14/async-form-errors-and-messages-in-angularjs/)\n// [Support for asynchronous values (like Promises and Observables)](https://github.com/facebook/react/issues/6481)\n// https://github.com/capaj/react-promise\n// [How to render promises in React](https://gist.github.com/hex13/6d46f8b54631871ea8bf87576b635c49)\n// Cannot be inside a separated npm package since FieldFeedback needs to attach itself to Async\nclass AsyncComponent<T = any> extends React.PureComponent<AsyncProps<T>, AsyncState<T>> {}\nexport class Async<T>\n  extends withValidateFieldEventEmitter<\n    // FieldFeedback returns FieldFeedbackValidation\n    FieldFeedbackValidation,\n    typeof AsyncComponent\n  >(AsyncComponent)\n  implements React.ChildContextProvider<AsyncChildContext> {\n  static contextTypes: React.ValidationMap<AsyncContext> = {\n    form: PropTypes.instanceOf(FormWithConstraints).isRequired,\n    fieldFeedbacks: PropTypes.instanceOf(FieldFeedbacks).isRequired\n  };\n  context!: AsyncContext;\n\n  static childContextTypes: React.ValidationMap<AsyncChildContext> = {\n    async: PropTypes.instanceOf(Async).isRequired\n  };\n  getChildContext(): AsyncChildContext {\n    return {\n      async: this\n    };\n  }\n\n  state: AsyncState<T> = {\n    status: Status.None\n  };\n\n  componentDidMount() {\n    this.context.fieldFeedbacks.addValidateFieldEventListener(this.validate);\n  }\n\n  componentWillUnmount() {\n    this.context.fieldFeedbacks.removeValidateFieldEventListener(this.validate);\n  }\n\n  validate = (input: InputElement) => {\n    const { form, fieldFeedbacks } = this.context;\n\n    let validations;\n\n    const field = form.fieldsStore.getField(input.name)!;\n\n    if (\n      (fieldFeedbacks.props.stop === 'first' && field.hasFeedbacks(fieldFeedbacks.key)) ||\n      (fieldFeedbacks.props.stop === 'first-error' && field.hasErrors(fieldFeedbacks.key)) ||\n      (fieldFeedbacks.props.stop === 'first-warning' && field.hasWarnings(fieldFeedbacks.key)) ||\n      (fieldFeedbacks.props.stop === 'first-info' && field.hasInfos(fieldFeedbacks.key))\n    ) {\n      // Reset UI\n      this.setState({ status: Status.None });\n    } else {\n      validations = this._validate(input);\n    }\n\n    return validations;\n  };\n\n  async _validate(input: InputElement) {\n    this.setState({ status: Status.Pending });\n    try {\n      const value = await this.props.promise(input.value);\n      this.setState({ status: Status.Resolved, value });\n    } catch (e) {\n      this.setState({ status: Status.Rejected, value: e });\n    }\n\n    return this.emitValidateFieldEvent(input);\n  }\n\n  render() {\n    const { props, state } = this;\n    let element = null;\n\n    switch (state.status) {\n      case Status.None:\n        break;\n      case Status.Pending:\n        if (props.pending) element = props.pending;\n        break;\n      case Status.Resolved:\n        if (props.then) element = props.then(state.value);\n        break;\n      case Status.Rejected:\n        if (props.catch) element = props.catch(state.value);\n        break;\n      default:\n        assert(false, `Unknown status: '${state.status}'`);\n    }\n\n    return element;\n  }\n}\n"]}