{"version":3,"file":"FieldFeedback.js","sourceRoot":"","sources":["../src/FieldFeedback.tsx"],"names":[],"mappings":"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","sourcesContent":["import * as React from 'react';\nimport * as PropTypes from 'prop-types';\n\nimport { Async, AsyncChildContext } from './Async';\nimport { Field } from './Field';\nimport { FieldFeedbacks, FieldFeedbacksChildContext } from './FieldFeedbacks';\nimport { FieldFeedbackType } from './FieldFeedbackType';\nimport { FieldFeedbackValidation } from './FieldFeedbackValidation';\nimport { FieldFeedbackWhenValid } from './FieldFeedbackWhenValid';\nimport { FormWithConstraints, FormWithConstraintsChildContext } from './FormWithConstraints';\nimport { InputElement } from './InputElement';\nimport { Nullable } from './Nullable';\n\ntype WhenString =\n  | 'valid'\n  | '*'\n  | 'badInput' // input type=\"number\"\n  | 'patternMismatch' // pattern attribute\n  | 'rangeOverflow' // max attribute\n  | 'rangeUnderflow' // min attribute\n  | 'stepMismatch' // step attribute\n  | 'tooLong' // maxlength attribute\n  | 'tooShort' // minlength attribute\n  | 'typeMismatch' // input type=\"email\" or input type=\"url\"\n  | 'valueMissing'; // required attribute\ntype WhenFn = (value: string) => boolean;\ntype When = WhenString | WhenFn;\n\nexport interface FieldFeedbackClasses {\n  classes?: {\n    // FIXME Should not be declared \"?\" thanks to defaultProps?\n    [index: string]: string | undefined;\n    error?: string;\n    warning?: string;\n    info?: string;\n    whenValid?: string;\n  };\n}\n\nexport interface FieldFeedbackBaseProps {\n  when?: When; // FIXME Should not be declared \"?\" thanks to defaultProps?\n  error?: boolean;\n  warning?: boolean;\n  info?: boolean;\n}\n\nexport interface FieldFeedbackProps\n  extends FieldFeedbackBaseProps,\n    FieldFeedbackClasses,\n    React.HTMLAttributes<HTMLSpanElement> {}\n\ninterface FieldFeedbackState {\n  validation: FieldFeedbackValidation;\n\n  // Copy of input.validationMessage\n  // https://developer.mozilla.org/en/docs/Web/API/HTMLInputElement\n  // https://www.w3.org/TR/html51/sec-forms.html#the-constraint-validation-api\n  validationMessage: string;\n}\n\n// Why Nullable? https://github.com/DefinitelyTyped/DefinitelyTyped/pull/27973\nexport type FieldFeedbackContext = FormWithConstraintsChildContext &\n  FieldFeedbacksChildContext &\n  Partial<Nullable<AsyncChildContext>>;\n\nexport class FieldFeedback<\n  Props extends FieldFeedbackBaseProps = FieldFeedbackProps\n> extends React.Component<Props, FieldFeedbackState> {\n  static defaultProps: FieldFeedbackProps = {\n    when: () => true,\n    classes: {\n      error: 'error',\n      warning: 'warning',\n      info: 'info',\n      whenValid: 'when-valid'\n    }\n  };\n\n  static contextTypes: React.ValidationMap<FieldFeedbackContext> = {\n    form: PropTypes.instanceOf(FormWithConstraints).isRequired,\n    fieldFeedbacks: PropTypes.instanceOf(FieldFeedbacks).isRequired,\n    async: PropTypes.instanceOf(Async)\n  };\n  context!: FieldFeedbackContext;\n\n  // Tested: there is no conflict with React key prop (https://reactjs.org/docs/lists-and-keys.html)\n  readonly key: string; // '0.1', '1.0', '3.5'...\n\n  constructor(props: Props, context: FieldFeedbackContext) {\n    super(props, context);\n\n    this.key = context.fieldFeedbacks.addFieldFeedback();\n\n    const { error, warning, info, when } = props;\n\n    let type = FieldFeedbackType.Error; // Default is error\n    if (when === 'valid') type = FieldFeedbackType.WhenValid;\n    else if (warning) type = FieldFeedbackType.Warning;\n    else if (info) type = FieldFeedbackType.Info;\n\n    // Special case for when=\"valid\"\n    if (type === FieldFeedbackType.WhenValid && (error || warning || info)) {\n      throw new Error(\n        'Cannot have an attribute (error, warning...) with FieldFeedback when=\"valid\"'\n      );\n    }\n\n    // eslint-disable-next-line react/state-in-constructor\n    this.state = {\n      validation: {\n        key: this.key,\n        type,\n        show: undefined // undefined means the FieldFeedback was not checked\n      },\n      validationMessage: ''\n    };\n  }\n\n  componentDidMount() {\n    const { form, fieldFeedbacks, async } = this.context;\n\n    if (async) async.addValidateFieldEventListener(this.validate);\n    else fieldFeedbacks.addValidateFieldEventListener(this.validate);\n\n    form.addFieldDidResetEventListener(this.fieldDidReset);\n  }\n\n  componentWillUnmount() {\n    const { form, fieldFeedbacks, async } = this.context;\n\n    if (async) async.removeValidateFieldEventListener(this.validate);\n    else fieldFeedbacks.removeValidateFieldEventListener(this.validate);\n\n    form.removeFieldDidResetEventListener(this.fieldDidReset);\n  }\n\n  validate = (input: InputElement) => {\n    const { when } = this.props;\n    const { form, fieldFeedbacks } = this.context;\n\n    const field = form.fieldsStore.getField(input.name)!;\n\n    // Copy state so we don't modify it directly (use of setState() instead)\n    // eslint-disable-next-line react/no-access-state-in-setstate, react/destructuring-assignment\n    const validation = { ...this.state.validation };\n\n    if (\n      (fieldFeedbacks.props.stop === 'first' && field.hasFeedbacks(fieldFeedbacks.key)) ||\n      (fieldFeedbacks.props.stop === 'first-error' && field.hasErrors(fieldFeedbacks.key)) ||\n      (fieldFeedbacks.props.stop === 'first-warning' && field.hasWarnings(fieldFeedbacks.key)) ||\n      (fieldFeedbacks.props.stop === 'first-info' && field.hasInfos(fieldFeedbacks.key))\n    ) {\n      // Do nothing\n      validation.show = undefined; // undefined means the FieldFeedback was not checked\n    } else {\n      validation.show = false;\n\n      if (typeof when === 'function') {\n        validation.show = when(input.value);\n      } else if (typeof when === 'string') {\n        if (when === 'valid') {\n          // undefined => special case for when=\"valid\": always displayed, then FieldFeedbackWhenValid decides what to do\n          validation.show = undefined;\n        } else {\n          const { validity } = input;\n\n          if (!validity.valid) {\n            if (when === '*') {\n              validation.show = true;\n            } else if (\n              (validity.badInput && when === 'badInput') ||\n              (validity.patternMismatch && when === 'patternMismatch') ||\n              (validity.rangeOverflow && when === 'rangeOverflow') ||\n              (validity.rangeUnderflow && when === 'rangeUnderflow') ||\n              (validity.stepMismatch && when === 'stepMismatch') ||\n              (validity.tooLong && when === 'tooLong') ||\n              (validity.tooShort && when === 'tooShort') ||\n              (validity.typeMismatch && when === 'typeMismatch') ||\n              (validity.valueMissing && when === 'valueMissing')\n            ) {\n              validation.show = true;\n            }\n          }\n        }\n      } else {\n        throw new TypeError(`Invalid FieldFeedback 'when' type: ${typeof when}`);\n      }\n    }\n\n    field.addOrReplaceValidation(validation);\n\n    this.setState({\n      validation,\n      validationMessage: input.validationMessage\n    });\n\n    return validation;\n  };\n\n  fieldDidReset = (field: Field) => {\n    // Ignore the event if it's not for us\n    // eslint-disable-next-line react/destructuring-assignment\n    if (field.name === this.context.fieldFeedbacks.fieldName) {\n      this.setState(prevState => ({\n        validation: { ...prevState.validation, ...{ show: undefined } },\n        validationMessage: ''\n      }));\n    }\n  };\n\n  // Don't forget to update native/FieldFeedback.render()\n  render() {\n    const { when, error, warning, info, className, classes, style, children, ...otherProps } = (this\n      .props as unknown) as FieldFeedbackProps;\n    const { validation, validationMessage } = this.state;\n\n    const fieldFeedbackClassName = classes![validation.type]!;\n    const classNames =\n      className !== undefined ? `${className} ${fieldFeedbackClassName}` : fieldFeedbackClassName;\n\n    // Special case for when=\"valid\": always displayed, then FieldFeedbackWhenValid decides what to do\n    if (validation.type === FieldFeedbackType.WhenValid) {\n      return (\n        <FieldFeedbackWhenValid\n          data-feedback={this.key}\n          style={style}\n          className={classNames}\n          {...otherProps}\n        >\n          {children}\n        </FieldFeedbackWhenValid>\n      );\n    }\n\n    if (validation.show) {\n      const feedback = children !== undefined ? children : validationMessage;\n\n      // <span style=\"display: block\"> instead of <div> so FieldFeedback can be wrapped inside a <p>\n      return (\n        <span\n          data-feedback={this.key}\n          className={classNames}\n          style={{ display: 'block', ...style }}\n          {...otherProps}\n        >\n          {feedback}\n        </span>\n      );\n    }\n\n    return null;\n  }\n}\n"]}