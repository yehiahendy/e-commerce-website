{"version":3,"file":"FieldFeedbacks.js","sourceRoot":"","sources":["../src/FieldFeedbacks.tsx"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA,6BAA+B;AAC/B,sCAAwC;AAGxC,6DAA6F;AAG7F,iFAAgF;AAqBhF;IAAsC,2CAAwC;IAA9E;;IAAgF,CAAC;IAAD,8BAAC;AAAD,CAAC,AAAjF,CAAsC,KAAK,CAAC,aAAa,GAAwB;AACjF;IACU,kCAMkB;IA0B1B,wBAAY,KAA0B,EAAE,OAA8B;QAAtE,YACE,kBAAM,KAAK,EAAE,OAAO,CAAC,SAoBtB;QAEO,6BAAuB,GAAG,CAAC,CAAC;QA2BpC,cAAQ,GAAG,UAAO,KAAmB;;;;;wBAC7B,KAAiD,IAAI,CAAC,OAAO,EAA3D,IAAI,UAAA,EAAkB,oBAAoB,oBAAA,CAAkB;6BAKhE,CAAA,KAAK,CAAC,IAAI,KAAK,IAAI,CAAC,SAAS,CAAA,EAA7B,cAA6B;wBACzB,KAAK,GAAG,IAAI,CAAC,WAAW,CAAC,QAAQ,CAAC,IAAI,CAAC,SAAS,CAAE,CAAC;6BAGrD,CAAA,oBAAoB,IAAI,CACxB,oBAAoB,CAAC,KAAK,CAAC,IAAI,KAAK,OAAO,IAAI,KAAK,CAAC,YAAY,CAAC,oBAAoB,CAAC,GAAG,CAAC;4BAC3F,oBAAoB,CAAC,KAAK,CAAC,IAAI,KAAK,aAAa,IAAI,KAAK,CAAC,SAAS,CAAC,oBAAoB,CAAC,GAAG,CAAC;4BAC9F,oBAAoB,CAAC,KAAK,CAAC,IAAI,KAAK,eAAe,IAAI,KAAK,CAAC,WAAW,CAAC,oBAAoB,CAAC,GAAG,CAAC;4BAClG,oBAAoB,CAAC,KAAK,CAAC,IAAI,KAAK,YAAY,IAAI,KAAK,CAAC,QAAQ,CAAC,oBAAoB,CAAC,GAAG,CAAC,CAAC,CAAA,EAJ7F,cAI6F;;4BAGjF,WAAM,IAAI,CAAC,SAAS,CAAC,KAAK,CAAC,EAAA;;wBAAzC,WAAW,GAAG,SAA2B,CAAC;;4BAI9C,WAAO,WAAW,EAAC;;;aACpB,CAAC;QArEQ,IAAA,IAAI,GAA2C,OAAO,KAAlD,EAAkB,oBAAoB,GAAK,OAAO,eAAZ,CAAa;QAE/D,KAAI,CAAC,GAAG,GAAG,oBAAoB;YAC7B,CAAC,CAAC,oBAAoB,CAAC,uBAAuB,EAAE;YAChD,CAAC,CAAC,IAAI,CAAC,wBAAwB,EAAE,CAAC;QAEpC,IAAI,oBAAoB,EAAE;YACxB,KAAI,CAAC,SAAS,GAAG,oBAAoB,CAAC,SAAS,CAAC;YAChD,IAAI,KAAK,CAAC,GAAG,KAAK,SAAS,EAAE;gBAC3B,MAAM,IAAI,KAAK,CAAC,sDAAsD,CAAC,CAAC;aACzE;SACF;aAAM;YACL,IAAI,KAAK,CAAC,GAAG,KAAK,SAAS,EAAE;gBAC3B,MAAM,IAAI,KAAK,CAAC,gEAAgE,CAAC,CAAC;aACnF;iBAAM;gBACL,KAAI,CAAC,SAAS,GAAG,KAAK,CAAC,GAAG,CAAC;aAC5B;SACF;;IACH,CAAC;IAhCD,wCAAe,GAAf;QACE,OAAO;YACL,cAAc,EAAE,IAAI;SACrB,CAAC;IACJ,CAAC;IA+BD,gDAAuB,GAAvB;QACE,OAAU,IAAI,CAAC,GAAG,SAAI,IAAI,CAAC,uBAAuB,EAAI,CAAC;IACzD,CAAC;IAED,yCAAgB,GAAhB;QACE,OAAO,IAAI,CAAC,uBAAuB,EAAE,CAAC;IACxC,CAAC;IAED,0CAAiB,GAAjB;QACQ,IAAA,KAAiD,IAAI,CAAC,OAAO,EAA3D,IAAI,UAAA,EAAkB,oBAAoB,oBAAiB,CAAC;QAEpE,IAAI,CAAC,WAAW,CAAC,QAAQ,CAAC,IAAI,CAAC,SAAS,CAAC,CAAC;QAE1C,IAAM,MAAM,GAAG,oBAAoB,IAAI,IAAI,CAAC;QAC5C,MAAM,CAAC,6BAA6B,CAAC,IAAI,CAAC,QAAQ,CAAC,CAAC;IACtD,CAAC;IAED,6CAAoB,GAApB;QACQ,IAAA,KAAiD,IAAI,CAAC,OAAO,EAA3D,IAAI,UAAA,EAAkB,oBAAoB,oBAAiB,CAAC;QAEpE,IAAI,CAAC,WAAW,CAAC,WAAW,CAAC,IAAI,CAAC,SAAS,CAAC,CAAC;QAE7C,IAAM,MAAM,GAAG,oBAAoB,IAAI,IAAI,CAAC;QAC5C,MAAM,CAAC,gCAAgC,CAAC,IAAI,CAAC,QAAQ,CAAC,CAAC;IACzD,CAAC;IA0BK,kCAAS,GAAf,UAAgB,KAAmB;;;;;4BACX,WAAM,IAAI,CAAC,sBAAsB,CAAC,KAAK,CAAC,EAAA;;wBAAxD,aAAa,GAAG,SAAwC;wBACxD,WAAW,GAAG,aAAa,CAAC,IAAI,CAAC,QAAQ,CAA4C,CAAC;wBAC5F,WAAO,WAAW,EAAC;;;;KACpB;IAED,+BAAM,GAAN;QACU,IAAA,QAAQ,GAAK,IAAI,CAAC,KAAK,SAAf,CAAgB;QAEhC,OAAO,QAAQ,KAAK,SAAS,CAAC,CAAC,CAAC,QAAQ,CAAC,CAAC,CAAC,IAAI,CAAC;IAClD,CAAC;IA5GM,2BAAY,GAAwB;QACzC,IAAI,EAAE,aAAa;KACpB,CAAC;IAEK,2BAAY,GAA+C;QAChE,IAAI,EAAE,SAAS,CAAC,UAAU,CAAC,yCAAmB,CAAC,CAAC,UAAU;QAC1D,cAAc,EAAE,SAAS,CAAC,UAAU,CAAC,cAAc,CAAC;KACrD,CAAC;IAGK,gCAAiB,GAAoD;QAC1E,cAAc,EAAE,SAAS,CAAC,UAAU,CAAC,cAAc,CAAC,CAAC,UAAU;KAChE,CAAC;IAiGJ,qBAAC;CAAA,AAtHD,CACU,6DAA6B,CAMnC,uBAAuB,CAAC,GA+G3B;AAtHY,wCAAc","sourcesContent":["import * as React from 'react';\nimport * as PropTypes from 'prop-types';\n\nimport { FieldFeedbackValidation } from './FieldFeedbackValidation';\nimport { FormWithConstraints, FormWithConstraintsChildContext } from './FormWithConstraints';\nimport { InputElement } from './InputElement';\nimport { Nullable } from './Nullable';\nimport { withValidateFieldEventEmitter } from './withValidateFieldEventEmitter';\n\nexport interface FieldFeedbacksProps {\n  for?: string;\n\n  /**\n   * first-* => stops on the first * encountered\n   * no => shows everything\n   * Default is 'first-error'\n   */\n  stop: 'first' | 'first-error' | 'first-warning' | 'first-info' | 'no';\n}\n\n// Why Nullable? https://github.com/DefinitelyTyped/DefinitelyTyped/pull/27973\nexport type FieldFeedbacksContext = FormWithConstraintsChildContext &\n  Partial<Nullable<FieldFeedbacksChildContext>>;\n\nexport interface FieldFeedbacksChildContext {\n  fieldFeedbacks: FieldFeedbacks;\n}\n\nclass FieldFeedbacksComponent extends React.PureComponent<FieldFeedbacksProps> {}\nexport class FieldFeedbacks\n  extends withValidateFieldEventEmitter<\n    // FieldFeedback returns FieldFeedbackValidation\n    // Async returns FieldFeedbackValidation[] | undefined\n    // FieldFeedbacks returns (FieldFeedbackValidation | undefined)[]\n    FieldFeedbackValidation | (FieldFeedbackValidation | undefined)[] | undefined,\n    typeof FieldFeedbacksComponent\n  >(FieldFeedbacksComponent)\n  implements React.ChildContextProvider<FieldFeedbacksChildContext> {\n  static defaultProps: FieldFeedbacksProps = {\n    stop: 'first-error'\n  };\n\n  static contextTypes: React.ValidationMap<FieldFeedbacksContext> = {\n    form: PropTypes.instanceOf(FormWithConstraints).isRequired,\n    fieldFeedbacks: PropTypes.instanceOf(FieldFeedbacks)\n  };\n  context!: FieldFeedbacksContext;\n\n  static childContextTypes: React.ValidationMap<FieldFeedbacksChildContext> = {\n    fieldFeedbacks: PropTypes.instanceOf(FieldFeedbacks).isRequired\n  };\n  getChildContext(): FieldFeedbacksChildContext {\n    return {\n      fieldFeedbacks: this\n    };\n  }\n\n  // Tested: there is no conflict with React key prop (https://reactjs.org/docs/lists-and-keys.html)\n  readonly key: string; // '0', '1', '2'...\n\n  readonly fieldName: string; // Instead of reading props each time\n\n  constructor(props: FieldFeedbacksProps, context: FieldFeedbacksContext) {\n    super(props, context);\n\n    const { form, fieldFeedbacks: fieldFeedbacksParent } = context;\n\n    this.key = fieldFeedbacksParent\n      ? fieldFeedbacksParent.computeFieldFeedbackKey()\n      : form.computeFieldFeedbacksKey();\n\n    if (fieldFeedbacksParent) {\n      this.fieldName = fieldFeedbacksParent.fieldName;\n      if (props.for !== undefined) {\n        throw new Error(\"FieldFeedbacks cannot have a parent and a 'for' prop\");\n      }\n    } else {\n      if (props.for === undefined) {\n        throw new Error(\"FieldFeedbacks cannot be without parent and without 'for' prop\");\n      } else {\n        this.fieldName = props.for;\n      }\n    }\n  }\n\n  private fieldFeedbackKeyCounter = 0;\n  computeFieldFeedbackKey() {\n    return `${this.key}.${this.fieldFeedbackKeyCounter++}`;\n  }\n\n  addFieldFeedback() {\n    return this.computeFieldFeedbackKey();\n  }\n\n  componentDidMount() {\n    const { form, fieldFeedbacks: fieldFeedbacksParent } = this.context;\n\n    form.fieldsStore.addField(this.fieldName);\n\n    const parent = fieldFeedbacksParent || form;\n    parent.addValidateFieldEventListener(this.validate);\n  }\n\n  componentWillUnmount() {\n    const { form, fieldFeedbacks: fieldFeedbacksParent } = this.context;\n\n    form.fieldsStore.removeField(this.fieldName);\n\n    const parent = fieldFeedbacksParent || form;\n    parent.removeValidateFieldEventListener(this.validate);\n  }\n\n  validate = async (input: InputElement) => {\n    const { form, fieldFeedbacks: fieldFeedbacksParent } = this.context;\n\n    let validations;\n\n    // Ignore the event if it's not for us\n    if (input.name === this.fieldName) {\n      const field = form.fieldsStore.getField(this.fieldName)!;\n\n      // prettier-ignore\n      if (fieldFeedbacksParent && (\n          fieldFeedbacksParent.props.stop === 'first' && field.hasFeedbacks(fieldFeedbacksParent.key) ||\n          fieldFeedbacksParent.props.stop === 'first-error' && field.hasErrors(fieldFeedbacksParent.key) ||\n          fieldFeedbacksParent.props.stop === 'first-warning' && field.hasWarnings(fieldFeedbacksParent.key) ||\n          fieldFeedbacksParent.props.stop === 'first-info' && field.hasInfos(fieldFeedbacksParent.key))) {\n        // Do nothing\n      } else {\n        validations = await this._validate(input);\n      }\n    }\n\n    return validations;\n  };\n\n  async _validate(input: InputElement) {\n    const arrayOfArrays = await this.emitValidateFieldEvent(input);\n    const validations = arrayOfArrays.flat(Infinity) as (FieldFeedbackValidation | undefined)[];\n    return validations;\n  }\n\n  render() {\n    const { children } = this.props;\n    // https://codepen.io/tkrotoff/pen/yzKKdB\n    return children !== undefined ? children : null;\n  }\n}\n"]}