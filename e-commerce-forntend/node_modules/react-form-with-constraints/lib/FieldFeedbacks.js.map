{"version":3,"file":"FieldFeedbacks.js","sourceRoot":"","sources":["../src/FieldFeedbacks.tsx"],"names":[],"mappings":"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","sourcesContent":["import * as React from 'react';\nimport * as PropTypes from 'prop-types';\n\nimport { FieldFeedbackValidation } from './FieldFeedbackValidation';\nimport { FormWithConstraints, FormWithConstraintsChildContext } from './FormWithConstraints';\nimport { InputElement } from './InputElement';\nimport { Nullable } from './Nullable';\nimport { withValidateFieldEventEmitter } from './withValidateFieldEventEmitter';\n\nexport interface FieldFeedbacksProps {\n  for?: string;\n\n  /**\n   * first-* => stops on the first * encountered\n   * no => shows everything\n   * Default is 'first-error'\n   */\n  stop: 'first' | 'first-error' | 'first-warning' | 'first-info' | 'no';\n}\n\n// Why Nullable? https://github.com/DefinitelyTyped/DefinitelyTyped/pull/27973\nexport type FieldFeedbacksContext = FormWithConstraintsChildContext &\n  Partial<Nullable<FieldFeedbacksChildContext>>;\n\nexport interface FieldFeedbacksChildContext {\n  fieldFeedbacks: FieldFeedbacks;\n}\n\nclass FieldFeedbacksComponent extends React.PureComponent<FieldFeedbacksProps> {}\nexport class FieldFeedbacks\n  extends withValidateFieldEventEmitter<\n    // FieldFeedback returns FieldFeedbackValidation\n    // Async returns FieldFeedbackValidation[] | undefined\n    // FieldFeedbacks returns (FieldFeedbackValidation | undefined)[]\n    FieldFeedbackValidation | (FieldFeedbackValidation | undefined)[] | undefined,\n    typeof FieldFeedbacksComponent\n  >(FieldFeedbacksComponent)\n  implements React.ChildContextProvider<FieldFeedbacksChildContext> {\n  static defaultProps: FieldFeedbacksProps = {\n    stop: 'first-error'\n  };\n\n  static contextTypes: React.ValidationMap<FieldFeedbacksContext> = {\n    form: PropTypes.instanceOf(FormWithConstraints).isRequired,\n    fieldFeedbacks: PropTypes.instanceOf(FieldFeedbacks)\n  };\n  context!: FieldFeedbacksContext;\n\n  static childContextTypes: React.ValidationMap<FieldFeedbacksChildContext> = {\n    fieldFeedbacks: PropTypes.instanceOf(FieldFeedbacks).isRequired\n  };\n  getChildContext(): FieldFeedbacksChildContext {\n    return {\n      fieldFeedbacks: this\n    };\n  }\n\n  // Tested: there is no conflict with React key prop (https://reactjs.org/docs/lists-and-keys.html)\n  readonly key: string; // '0', '1', '2'...\n\n  readonly fieldName: string; // Instead of reading props each time\n\n  constructor(props: FieldFeedbacksProps, context: FieldFeedbacksContext) {\n    super(props, context);\n\n    const { form, fieldFeedbacks: fieldFeedbacksParent } = context;\n\n    this.key = fieldFeedbacksParent\n      ? fieldFeedbacksParent.computeFieldFeedbackKey()\n      : form.computeFieldFeedbacksKey();\n\n    if (fieldFeedbacksParent) {\n      this.fieldName = fieldFeedbacksParent.fieldName;\n      if (props.for !== undefined) {\n        throw new Error(\"FieldFeedbacks cannot have a parent and a 'for' prop\");\n      }\n    } else {\n      if (props.for === undefined) {\n        throw new Error(\"FieldFeedbacks cannot be without parent and without 'for' prop\");\n      } else {\n        this.fieldName = props.for;\n      }\n    }\n  }\n\n  private fieldFeedbackKeyCounter = 0;\n  computeFieldFeedbackKey() {\n    return `${this.key}.${this.fieldFeedbackKeyCounter++}`;\n  }\n\n  addFieldFeedback() {\n    return this.computeFieldFeedbackKey();\n  }\n\n  componentDidMount() {\n    const { form, fieldFeedbacks: fieldFeedbacksParent } = this.context;\n\n    form.fieldsStore.addField(this.fieldName);\n\n    const parent = fieldFeedbacksParent || form;\n    parent.addValidateFieldEventListener(this.validate);\n  }\n\n  componentWillUnmount() {\n    const { form, fieldFeedbacks: fieldFeedbacksParent } = this.context;\n\n    form.fieldsStore.removeField(this.fieldName);\n\n    const parent = fieldFeedbacksParent || form;\n    parent.removeValidateFieldEventListener(this.validate);\n  }\n\n  validate = async (input: InputElement) => {\n    const { form, fieldFeedbacks: fieldFeedbacksParent } = this.context;\n\n    let validations;\n\n    // Ignore the event if it's not for us\n    if (input.name === this.fieldName) {\n      const field = form.fieldsStore.getField(this.fieldName)!;\n\n      // prettier-ignore\n      if (fieldFeedbacksParent && (\n          fieldFeedbacksParent.props.stop === 'first' && field.hasFeedbacks(fieldFeedbacksParent.key) ||\n          fieldFeedbacksParent.props.stop === 'first-error' && field.hasErrors(fieldFeedbacksParent.key) ||\n          fieldFeedbacksParent.props.stop === 'first-warning' && field.hasWarnings(fieldFeedbacksParent.key) ||\n          fieldFeedbacksParent.props.stop === 'first-info' && field.hasInfos(fieldFeedbacksParent.key))) {\n        // Do nothing\n      } else {\n        validations = await this._validate(input);\n      }\n    }\n\n    return validations;\n  };\n\n  async _validate(input: InputElement) {\n    const arrayOfArrays = await this.emitValidateFieldEvent(input);\n    const validations = arrayOfArrays.flat(Infinity) as (FieldFeedbackValidation | undefined)[];\n    return validations;\n  }\n\n  render() {\n    const { children } = this.props;\n    // https://codepen.io/tkrotoff/pen/yzKKdB\n    return children !== undefined ? children : null;\n  }\n}\n"]}