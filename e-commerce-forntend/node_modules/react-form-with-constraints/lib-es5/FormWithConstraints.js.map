{"version":3,"file":"FormWithConstraints.js","sourceRoot":"","sources":["../src/FormWithConstraints.tsx"],"names":[],"mappings":"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","sourcesContent":["import * as React from 'react';\nimport * as PropTypes from 'prop-types';\n\nimport { assert } from './assert';\nimport { Field } from './Field';\nimport { FieldFeedbackValidation } from './FieldFeedbackValidation';\nimport { FieldsStore } from './FieldsStore';\nimport { HTMLInput, IHTMLInput, InputElement, TextInput } from './InputElement';\nimport { notUndefined } from './notUndefined';\nimport { withFieldDidResetEventEmitter } from './withFieldDidResetEventEmitter';\nimport { withFieldDidValidateEventEmitter } from './withFieldDidValidateEventEmitter';\nimport { withFieldWillValidateEventEmitter } from './withFieldWillValidateEventEmitter';\nimport { withValidateFieldEventEmitter } from './withValidateFieldEventEmitter';\n\nexport interface FormWithConstraintsChildContext {\n  form: FormWithConstraints;\n}\n\nexport interface FormWithConstraintsProps extends React.FormHTMLAttributes<HTMLFormElement> {}\n\nclass FormWithConstraintsComponent extends React.PureComponent<FormWithConstraintsProps> {}\nexport class FormWithConstraints\n  extends withFieldDidResetEventEmitter(\n    withFieldWillValidateEventEmitter(\n      withFieldDidValidateEventEmitter(\n        withValidateFieldEventEmitter<\n          // FieldFeedback returns FieldFeedbackValidation\n          // Async returns FieldFeedbackValidation[] | undefined\n          // FieldFeedbacks returns (FieldFeedbackValidation | undefined)[] | undefined\n          FieldFeedbackValidation | (FieldFeedbackValidation | undefined)[] | undefined,\n          typeof FormWithConstraintsComponent\n        >(FormWithConstraintsComponent)\n      )\n    )\n  )\n  implements React.ChildContextProvider<FormWithConstraintsChildContext> {\n  static childContextTypes: React.ValidationMap<FormWithConstraintsChildContext> = {\n    form: PropTypes.instanceOf(FormWithConstraints).isRequired\n  };\n  getChildContext(): FormWithConstraintsChildContext {\n    return {\n      form: this\n    };\n  }\n\n  // Could be named innerRef instead, https://github.com/ant-design/ant-design/issues/5489#issuecomment-332208652\n  private form: HTMLFormElement | null = null;\n\n  fieldsStore = new FieldsStore();\n\n  private fieldFeedbacksKeyCounter = 0;\n  computeFieldFeedbacksKey() {\n    return `${this.fieldFeedbacksKeyCounter++}`;\n  }\n\n  /**\n   * Validates the given fields, either HTMLInputElements or field names.\n   * If called without arguments, validates all fields ($('[name]')).\n   */\n  validateFields(...inputsOrNames: Array<IHTMLInput | string>) {\n    return this._validateFields(/* forceValidateFields */ true, ...inputsOrNames);\n  }\n\n  // TODO To be removed in the future?\n  validateForm() {\n    return this.validateFieldsWithoutFeedback();\n  }\n\n  /**\n   * Validates fields without feedback only.\n   */\n  validateFieldsWithoutFeedback(...inputsOrNames: Array<IHTMLInput | string>) {\n    return this._validateFields(/* forceValidateFields */ false, ...inputsOrNames);\n  }\n\n  private async _validateFields(\n    forceValidateFields: boolean,\n    ...inputsOrNames: Array<IHTMLInput | string>\n  ) {\n    const fields = new Array<Readonly<Field>>();\n\n    const inputs = this.normalizeInputs(...inputsOrNames);\n\n    for (let i = 0; i < inputs.length; i++) {\n      const input = inputs[i];\n      // eslint-disable-next-line no-await-in-loop\n      const field = await this.validateField(\n        forceValidateFields,\n        new InputElement(input),\n        input as HTMLInput | TextInput\n      );\n      if (field !== undefined) fields.push(field);\n    }\n\n    return fields;\n  }\n\n  private async validateField(\n    forceValidateFields: boolean,\n    input: InputElement,\n\n    // We need to pass the native input separately instead of it being a property of InputElement\n    // otherwise react-form-with-constraints-native unit tests will crash\n    nativeInput: HTMLInput | TextInput\n  ) {\n    const fieldName = input.name;\n    const field = this.fieldsStore.getField(fieldName);\n\n    if (field === undefined) {\n      // Means the field (<input name=\"username\">) does not have a FieldFeedbacks\n      // so let's ignore this field\n    } else if (forceValidateFields || !field.hasFeedbacks()) {\n      field.element = nativeInput as HTMLInput | TextInput;\n      field.clearValidations();\n\n      this.emitFieldWillValidateEvent(fieldName);\n\n      const arrayOfArrays = await this.emitValidateFieldEvent(input);\n\n      // Internal check that everything is OK\n      // Can be temporary out of sync if the user rapidly change the input, in this case:\n      // emitFieldWillValidateEvent() returns the result of the first change while the store already contains the final validations\n      assert(\n        JSON.stringify(\n          (arrayOfArrays.flat(Infinity) as (\n            | FieldFeedbackValidation\n            | undefined\n          )[]).filter(fieldFeedback => notUndefined(fieldFeedback))\n        ) /* validationsFromEmitValidateFieldEvent */ ===\n          JSON.stringify(field.validations) /* validationsFromStore */,\n        `FieldsStore does not match emitValidateFieldEvent() result, did the user changed the input rapidly?`\n      );\n\n      this.emitFieldDidValidateEvent(field);\n    }\n\n    return field;\n  }\n\n  // If called without arguments, returns all fields ($('[name]'))\n  // Returns the inputs in the same order they were given\n  protected normalizeInputs(...inputsOrNames: Array<IHTMLInput | string>) {\n    let inputs;\n\n    if (inputsOrNames.length === 0) {\n      // [name] matches <input name=\"...\">, <select name=\"...\">, <button name=\"...\">, ...\n      // [Convert JavaScript NodeList to Array?](https://stackoverflow.com/a/33822526/990356)\n      // [...NodeList] vs Array.from(NodeList): the latter doesn't need downlevelIteration with IE\n      // eslint-disable-next-line unicorn/prefer-spread\n      inputs = Array.from(this.form!.querySelectorAll<HTMLInputElement>('[name]'));\n\n      // Remove elements without ValidityState, example:\n      // <iframe src=\"https://www.google.com/recaptcha...\" name=\"a-49ekipqfmwsv\">\n      // Without this check, possible crash inside InputElement is \"TypeError: Cannot read property 'badInput' of undefined\"\n      //\n      // ValidityState is available for (lib.dom.d.ts):\n      // HTMLButtonElement, HTMLFieldSetElement, HTMLInputElement, HTMLObjectElement,\n      // HTMLOutputElement, HTMLSelectElement, HTMLTextAreaElement\n      //\n      // ValidityState is supported by IE >= 10\n      inputs = inputs.filter(input => input.validity !== undefined);\n\n      // Check we have unique names\n      inputs\n        .filter(input => input.type !== 'checkbox' && input.type !== 'radio')\n        .map(input => input.name)\n        .forEach((name, index, self) => {\n          if (self.indexOf(name) !== index) {\n            throw new Error(`Multiple elements matching '[name=\"${name}\"]' inside the form`);\n          }\n        });\n    } else {\n      inputs = inputsOrNames.map(input => {\n        if (typeof input === 'string') {\n          const query = `[name=\"${input}\"]`;\n\n          // [...NodeList] vs Array.from(NodeList): the latter doesn't need downlevelIteration with IE\n          // eslint-disable-next-line unicorn/prefer-spread\n          const elements = Array.from(this.form!.querySelectorAll<HTMLInputElement>(query));\n\n          // Checks\n\n          if (elements.filter(el => el.validity === undefined).length > 0) {\n            // Should not match something like\n            // <iframe src=\"https://www.google.com/recaptcha...\" name=\"a-49ekipqfmwsv\">\n            throw new Error(`'${query}' should match an <input>, <select> or <textarea>`);\n          }\n          if (elements.filter(el => el.type !== 'checkbox' && el.type !== 'radio').length > 1) {\n            throw new Error(`Multiple elements matching '${query}' inside the form`);\n          }\n          const element = elements[0];\n          if (element === undefined) {\n            throw new Error(`Could not find field '${query}' inside the form`);\n          }\n\n          return element;\n        }\n\n        return input;\n      });\n    }\n\n    return inputs;\n  }\n\n  // More like seemsToBeValid(): return true if fields are untouched\n  isValid() {\n    return this.fieldsStore.isValid();\n  }\n\n  hasFeedbacks() {\n    return this.fieldsStore.hasFeedbacks();\n  }\n\n  // TODO To be removed in the future?\n  reset() {\n    return this.resetFields();\n  }\n\n  resetFields(...inputsOrNames: Array<IHTMLInput | string>) {\n    const fields = new Array<Readonly<Field>>();\n\n    const inputs = this.normalizeInputs(...inputsOrNames);\n    inputs.forEach(input => {\n      const field = this.resetField(new InputElement(input));\n      if (field !== undefined) fields.push(field);\n    });\n\n    return fields;\n  }\n\n  private resetField(input: InputElement) {\n    const fieldName = input.name;\n    const field = this.fieldsStore.getField(fieldName);\n\n    if (field === undefined) {\n      // Means the field (<input name=\"username\">) does not have a FieldFeedbacks\n      // so let's ignore this field\n    } else {\n      field.clearValidations();\n      this.emitFieldDidResetEvent(field);\n    }\n\n    return field;\n  }\n\n  render() {\n    return <form ref={form => (this.form = form)} {...this.props} />;\n  }\n}\n"]}